global:
  serviceMonitor:
    adservice:
      enabled: true
    dataservice:
      enabled: true
    kafka:
      enabled: true

extensions:
  mysql:
    enabled: true
  dataservice:
    enabled: true
    image:
      repository: ghcr.io/openinsight-proj/demo
      tag: "v1.4.0-beta-daocloud-dataservice"
      pullPolicy: Always
    servcie:
      type: NodePort
    ports:
      - name: http
        containerPort: 8082
        protocol: TCP
      - name: health-http
        containerPort: 8999
        protocol: TCP
      - name: http-metrics
        containerPort: 8888
        protocol: TCP
      - name: jvm-metrics
        containerPort: 9464
        protocol: TCP
    env:
      - name: OTEL_EXPORTER_OTLP_ENDPOINT
        value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      - name: NACOS_NAMESPACE_ID
        value: public
      - name: NACOS_GROUP_NAME
        value: DEFAULT_GROUP
      - name: SKOALA_REGISTRY
        value: nacos-test
      - name: OTEL_RESOURCE_ATTRIBUTES
        value: >-
          k8s.namespace.name=$(K8S_NAMESPACE),k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME),k8s.pod.uid=$(OTEL_RESOURCE_ATTRIBUTES_POD_UID),skoala.registry=$(SKOALA_REGISTRY),nacos.namespaceid=$(NACOS_NAMESPACE_ID),nacos.groupname=$(NACOS_GROUP_NAME)
      - name: JAVA_OPTS
        value: "-XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m -Dotel.metrics.exporter=prometheus -Dotel.exporter.prometheus.port=9464 -Dspring.extraAdLabel=Daocloud -Dspring.matrixRow=200 -Dmeter.port=8888 -Dspring.cloud.nacos.discovery.enabled=false -Dspring.cloud.nacos.config.enabled=false -Dspring.cloud.sentinel.enabled=false -Dspring.cloud.nacos.config.server-addr=nacos-test.skoala-test:8848 -Dspring.application.name=adservice-springcloud -Dspring.cloud.nacos.discovery.server-addr=nacos-test.skoala-test:8848 -Dspring.cloud.nacos.discovery.namespace=$(NACOS_NAMESPACE_ID) -Dspring.cloud.nacos.discovery.group=$(NACOS_GROUP_NAME) -Dspring.cloud.nacos.discovery.metadata.k8s_cluster_id=xxx -Dspring.cloud.nacos.discovery.metadata.k8s_cluster_name=skoala-dev -Dspring.cloud.nacos.discovery.metadata.k8s_namespace_name=skoala-test -Dspring.cloud.nacos.discovery.metadata.k8s_workload_type=deployment -Dspring.cloud.nacos.discovery.metadata.k8s_workload_name=adservice-springcloud -Dspring.cloud.nacos.discovery.metadata.k8s_service_name=adservice-springcloud -Dspring.cloud.nacos.discovery.metadata.k8s_pod_name=$(HOSTNAME)  -Dspring.cloud.sentinel.transport.dashboard=nacos-test-sentinel.skoala-test:8080"
    podAnnotations:
      instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
      insight.opentelemetry.io/metric-scrape: "true"
      insight.opentelemetry.io/metric-path: "/"
      insight.opentelemetry.io/metric-port: "9464"
  frontendNodePortSvc:
    enabled: true
  cartservice:
    enabled: true

opentelemetry-demo:
  enabled: true

  default:
    image:
      repository: ghcr.io/openinsight-proj/demo
      tag: "v1.4.0-beta-daocloud"

  serviceAccount:
    create: false

  components:
    accountingService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: KAFKA_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-kafka:9092'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
      initContainers:
        - name: wait-for-kafka
          image: docker.m.daocloud.io/busybox:1.36.0
          command: [ 'sh', '-c', 'until nc -z -v -w30 {{ include "otel-demo.name" . }}-kafka 9092; do echo waiting for kafka; sleep 2; done;' ]

    adService:
      enabled: true
      useDefault:
        env: false
      imageOverride:
        tag: "58978c1cd9603ffe4e7abd71cd024372c0dcbc4d-adservice-v2"
      ports:
        - name: http
          value: 8081
        - name: health-http
          value: 8999
        - name: metrics
          value: 12345
        - name: http-metrics
          value: 8888
        - name: jvm-metrics
          value: 9464
      env:
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
        - name: AD_SERVICE_PORT
          value: "8080"
        - name: NACOS_NAMESPACE_ID
          value: public
        - name: NACOS_GROUP_NAME
          value: DEFAULT_GROUP
        - name: SKOALA_REGISTRY
          value: nacos-test
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: k8s.namespace.name=$(K8S_NAMESPACE),k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME),k8s.pod.uid=$(OTEL_RESOURCE_ATTRIBUTES_POD_UID),skoala.registry=$(SKOALA_REGISTRY),nacos.namespaceid=$(NACOS_NAMESPACE_ID),nacos.groupname=$(NACOS_GROUP_NAME)
        - name: JAVA_OPTS
          value: "-XX:MetaspaceSize=512m -XX:MaxMetaspaceSize=512m -Dotel.metrics.exporter=prometheus -Dotel.exporter.prometheus.port=9464 -javaagent:./jmx_prometheus_javaagent-0.17.0.jar=12345:./prometheus-jmx-config.yaml -Dspring.extraAdLabel=Daocloud -Dspring.randomError=false -Dspring.matrixRow=200 -Dmeter.port=8888 -Dspring.cloud.nacos.discovery.enabled=false -Dspring.cloud.nacos.config.enabled=false -Dspring.cloud.sentinel.enabled=false -Dspring.cloud.nacos.config.server-addr=nacos-test.skoala-test:8848 -Dspring.cloud.nacos.discovery.namespace=$(NACOS_NAMESPACE_ID) -Dspring.cloud.nacos.discovery.group=$(NACOS_GROUP_NAME) -Dspring.application.name=adservice-springcloud -Dspring.cloud.nacos.discovery.server-addr=nacos-test.skoala-test:8848 -Dspring.cloud.nacos.discovery.metadata.k8s_cluster_id=xxx -Dspring.cloud.nacos.discovery.metadata.k8s_cluster_name=skoala-dev -Dspring.cloud.nacos.discovery.metadata.k8s_namespace_name=skoala-test -Dspring.cloud.nacos.discovery.metadata.k8s_workload_type=deployment -Dspring.cloud.nacos.discovery.metadata.k8s_workload_name=adservice-springcloud -Dspring.cloud.nacos.discovery.metadata.k8s_service_name=adservice-springcloud -Dspring.cloud.nacos.discovery.metadata.k8s_pod_name=$(HOSTNAME)  -Dspring.cloud.sentinel.transport.dashboard=nacos-test-sentinel.skoala-test:8080"
      resources:
        limits:
          memory: 1Gi
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
        insight.opentelemetry.io/metric-scrape: "true"
        insight.opentelemetry.io/metric-path: "/"
        insight.opentelemetry.io/metric-port: "12345"

    # this component is redefined in /template/cartservice.yaml
    # cartservice deploy by /template/cartservice.yaml supports switch redis deploy style
    cartService:
      enabled: false

    checkoutService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: CHECKOUT_SERVICE_PORT
          value: "8080"
        - name: CART_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-cartservice:8080'
        - name: CURRENCY_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-currencyservice:8080'
        - name: EMAIL_SERVICE_ADDR
          value: 'http://{{ include "otel-demo.name" . }}-emailservice:8080'
        - name: PAYMENT_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-paymentservice:8080'
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-productcatalogservice:8080'
        - name: SHIPPING_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-shippingservice:8080'
        - name: KAFKA_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-kafka:9092'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
      initContainers:
        - name: wait-for-kafka
          image: docker.m.daocloud.io/busybox:1.36.0
          command: [ 'sh', '-c', 'until nc -z -v -w30 {{ include "otel-demo.name" . }}-kafka 9092; do echo waiting for kafka; sleep 2; done;' ]

    currencyService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: CURRENCY_SERVICE_PORT
          value: "8080"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    emailService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: EMAIL_SERVICE_PORT
          value: "8080"
        - name: APP_ENV
          value: production
        - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4318/v1/traces'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    featureflagService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: FEATURE_FLAG_SERVICE_PORT
          value: "8081"
        - name: FEATURE_FLAG_GRPC_SERVICE_PORT
          value: "50053"
        - name: DATABASE_URL
          value: 'ecto://ffs:ffs@{{ include "otel-demo.name" . }}-ffspostgres:5432/ffs'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
        - name: OTEL_EXPORTER_OTLP_TRACES_PROTOCOL
          value: grpc
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
      initContainers:
        - name: wait-for-ffspostgres
          image: docker.m.daocloud.io/busybox:1.36.0
          command: [ 'sh', '-c', 'until nc -z -v -w30 {{ include "otel-demo.name" . }}-ffspostgres 5432; do echo waiting for ffspostgres; sleep 2; done' ]

    frauddetectionService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: KAFKA_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-kafka:9092'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"
      initContainers:
        - name: wait-for-kafka
          image: docker.m.daocloud.io/busybox:1.36.0
          command: [ 'sh', '-c', 'until nc -z -v -w30 {{ include "otel-demo.name" . }}-kafka 9092; do echo waiting for kafka; sleep 2; done;' ]

    frontend:
      enabled: true
      useDefault:
        env: false
      env:
        - name: FRONTEND_PORT
          value: "8080"
        - name: FRONTEND_ADDR
          value: :8080
        - name: AD_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-adservice:8080'
        - name: CART_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-cartservice:8080'
        - name: CHECKOUT_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-checkoutservice:8080'
        - name: CURRENCY_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-currencyservice:8080'
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-productcatalogservice:8080'
        - name: RECOMMENDATION_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-recommendationservice:8080'
        - name: SHIPPING_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-shippingservice:8080'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
        - name: WEB_OTEL_SERVICE_NAME
          value: frontend-web
        - name: PUBLIC_OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: http://localhost:4318/v1/traces             # This expects users to use `kubectl port-forward ...`
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    frontendProxy:
      enabled: true
      useDefault:
        env: false
      resources:
        limits:
          memory: 100Mi

    loadgenerator:
      enabled: true
      useDefault:
        env: false
      env:
        - name: LOCUST_WEB_PORT
          value: "8089"
        - name: LOCUST_USERS
          value: "10"
        - name: LOCUST_SPAWN_RATE
          value: "1"
        - name: LOCUST_HOST
          value: 'http://{{ include "otel-demo.name" . }}-frontend:8080'
        - name: LOCUST_HEADLESS
          value: "false"
        - name: LOCUST_AUTOSTART
          value: "true"
        - name: PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION
          value: python
        - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4318/v1/traces'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    paymentService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: PAYMENT_SERVICE_PORT
          value: "8080"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    productCatalogService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: PRODUCT_CATALOG_SERVICE_PORT
          value: "8080"
        - name: FEATURE_FLAG_GRPC_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-featureflagservice:50053'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    quoteService:
      enabled: true
      useDefault:
        env: false
      service:
        port: 8080
      env:
        - name: QUOTE_SERVICE_PORT
          value: "8080"
        - name: OTEL_PHP_AUTOLOAD_ENABLED
          value: "true"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4318'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    recommendationService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: RECOMMENDATION_SERVICE_PORT
          value: "8080"
        - name: PRODUCT_CATALOG_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-productcatalogservice:8080'
        - name: FEATURE_FLAG_GRPC_SERVICE_ADDR
          value: '{{ include "otel-demo.name" . }}-featureflagservice:50053'
        - name: OTEL_PYTHON_LOG_CORRELATION
          value: "true"
        - name: PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION
          value: python
        - name: OTEL_SERVICE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: "metadata.labels['app.kubernetes.io/component']"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    shippingService:
      enabled: true
      useDefault:
        env: false
      env:
        - name: SHIPPING_SERVICE_PORT
          value: "8080"
        - name: QUOTE_SERVICE_ADDR
          value: 'http://{{ include "otel-demo.name" . }}-quoteservice:8080'
        - name: OTEL_EXPORTER_OTLP_TRACES_ENDPOINT
          value: "http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4318/v1/traces"
      podAnnotations:
        instrumentation.opentelemetry.io/inject-sdk: "insight-system/insight-opentelemetry-autoinstrumentation"

    ffsPostgres:
      enabled: true
      imageOverride:
        repository: "docker.m.daocloud.io/postgres"

    kafka:
      enabled: true
      useDefault:
        env: false
      ports:
        - name: plaintext
          value: 9092
        - name: controller
          value: 9093
        - name: jvm-metrics
          value: 9464
      env:
        - name: KAFKA_ADVERTISED_LISTENERS
          value: 'PLAINTEXT://{{ include "otel-demo.name" . }}-kafka:9092'
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: 'http://insight-agent-opentelemetry-collector.insight-system.svc.cluster.local:4317'
        - name: KAFKA_HEAP_OPTS
          value: "-Xmx400M -Xms400M"
        - name: KAFKA_OPTS
          value: "-javaagent:/tmp/opentelemetry-javaagent.jar -Dotel.metrics.exporter=prometheus -Dotel.exporter.prometheus.port=9464 -Dotel.jmx.target.system=kafka-broker"

    redis:
      enabled: true
      useDefault:
        env: true
      imageOverride:
        repository: "docker.m.daocloud.io/redis"

  opentelemetry-collector:
    enabled: false

  jaeger:
    enabled: false

  prometheus:
    enabled: false

  grafana:
    enabled: false

redis_operator:
  enabled: false

redis_resource:
  enabled: false
  storageClassName: openebs-hostpath
  storageSize: 1Gi
